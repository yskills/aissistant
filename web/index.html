<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luna Assistant Dev UI</title>
  <style>
    :root {
      --glass-bg: rgba(255,255,255,0.12);
      --glass-border: rgba(255,255,255,0.22);
      --txt: #f3f6ff;
      --txt-dim: #c8d0ee;
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --trading: #f59e0b;
      --news: #3b82f6;
      --support: #10b981;
      --user: #8b5cf6;
      --luna-a: #ff8bd6;
      --luna-b: #8ea6ff;
      color-scheme: dark;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, Segoe UI, Arial, sans-serif;
      color: var(--txt);
      background: radial-gradient(1000px 700px at 100% 0%, #2a1f48 0%, #0d1326 52%), #0d1326;
      min-height: 100vh;
    }

    .assistant-fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 1000;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      background: linear-gradient(135deg, var(--luna-a), var(--luna-b));
      color: #130f29;
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
      transition: transform .2s ease, filter .2s ease;
    }
    .assistant-fab:hover { transform: scale(1.05); filter: brightness(1.08); }

    .panel {
      position: fixed;
      right: 18px;
      bottom: 82px;
      width: min(380px, calc(100vw - 24px));
      height: min(80vh, 760px);
      border-radius: 18px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow: hidden;
      display: none;
      flex-direction: column;
      box-shadow: 0 22px 44px rgba(0,0,0,0.45);
      z-index: 999;
      animation: slideIn .25s ease;
    }

    .panel.open { display: flex; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .panel-head,
    .panel-tabs,
    .panel-foot,
    .settings-section {
      border-bottom: 1px solid rgba(255,255,255,.14);
      background: rgba(12,18,40,.35);
      backdrop-filter: blur(8px);
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      gap: 8px;
    }

    .assistant-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #15112b;
      background: linear-gradient(135deg, var(--luna-a), var(--luna-b));
      cursor: pointer;
      user-select: none;
    }

    .assistant-meta h2 {
      margin: 0;
      font-size: 16px;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status {
      font-size: 12px;
      font-weight: 600;
      color: var(--txt-dim);
    }

    .status.live { color: var(--ok); }
    .status.fallback { color: var(--warn); }

    .head-actions { display: flex; gap: 6px; }

    .icon-btn,
    .chip-btn,
    .action-btn,
    .primary,
    .danger,
    .soft {
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      color: var(--txt);
      min-height: 34px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: transform .15s ease, background .15s ease;
    }

    .icon-btn:hover,
    .chip-btn:hover,
    .action-btn:hover,
    .primary:hover,
    .danger:hover,
    .soft:hover {
      transform: translateY(-1px);
      background: rgba(255,255,255,.16);
    }

    .panel-tabs {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      gap: 8px;
    }

    .tabs {
      display: flex;
      gap: 6px;
    }

    .tab {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.08);
      color: var(--txt-dim);
      font-size: 12px;
      cursor: pointer;
    }

    .tab.active { color: var(--txt); background: rgba(255,255,255,.18); }

    .mode-toggle {
      min-width: 76px;
      text-align: center;
      font-size: 12px;
      border-radius: 999px;
    }

    .panel-body {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      background: rgba(10,16,34,.35);
    }

    .chat-view,
    .settings-view {
      height: 100%;
      display: none;
      flex-direction: column;
    }

    .chat-view.active,
    .settings-view.active { display: flex; }

    .chat-scroll {
      flex: 1;
      overflow: auto;
      padding: 10px;
    }

    .day-sep {
      text-align: center;
      font-size: 12px;
      color: var(--txt-dim);
      margin: 6px 0 12px;
      opacity: .85;
    }

    .message {
      display: grid;
      grid-template-columns: 36px 1fr;
      gap: 8px;
      margin-bottom: 10px;
      align-items: end;
      animation: fadeIn .2s ease;
    }

    .message.user {
      grid-template-columns: 1fr 36px;
    }

    .msg-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 700;
      color: #100b25;
      background: linear-gradient(135deg, #99a8ff, #ff9ed9);
    }

    .message.user .msg-avatar {
      background: linear-gradient(135deg, #9f85ff, #7ba6ff);
      color: white;
      order: 2;
    }

    .msg-stack { min-width: 0; }

    .bubble {
      display: inline-block;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid rgba(255,255,255,.18);
    }

    .message.assistant .bubble {
      background: linear-gradient(135deg, rgba(255,139,214,.65), rgba(142,166,255,.65));
      color: #150f2d;
    }

    .message.user .bubble {
      background: rgba(200,200,220,.28);
      color: #fff;
    }

    .message.user .msg-stack { text-align: right; }

    .meta {
      margin-top: 4px;
      font-size: 12px;
      color: var(--txt-dim);
    }

    .msg-actions {
      margin-top: 5px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .message.user .msg-actions { justify-content: flex-end; }

    .action-btn { min-height: 24px; border-radius: 999px; font-size: 11px; padding: 2px 8px; }
    .action-btn.active { background: rgba(255,255,255,.25); }

    .thinking {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.2);
      font-size: 12px;
      color: var(--txt-dim);
      margin: 8px 0;
    }

    .dots::after {
      content: '...';
      display: inline-block;
      width: 1em;
      text-align: left;
      animation: dots 1.2s steps(4, end) infinite;
      overflow: hidden;
      vertical-align: bottom;
    }

    @keyframes dots {
      0% { width: 0; }
      100% { width: 1em; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .panel-foot {
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    #chatInput {
      resize: none;
      min-height: 42px;
      max-height: 120px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.08);
      color: var(--txt);
      padding: 9px 10px;
      font: inherit;
    }

    .send-btn {
      min-width: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, #7f9bff, #ff8bd6);
      color: #1b1231;
      font-size: 18px;
      font-weight: 700;
    }

    .settings-scroll {
      padding: 10px;
      overflow: auto;
    }

    .overview {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .ov-card {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      padding: 8px;
      text-align: center;
    }

    .ov-card strong { font-size: 16px; display: block; }
    .ov-card span { font-size: 12px; color: var(--txt-dim); }

    .settings-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .primary { background: rgba(59,130,246,.35); }
    .soft { background: rgba(251,146,60,.25); }
    .danger { background: rgba(239,68,68,.32); }

    .section-title { font-size: 13px; margin: 0 0 8px; color: var(--txt-dim); }

    .line { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    .line input, .line select {
      flex: 1;
      min-height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.08);
      color: var(--txt);
      padding: 7px 9px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(7,9,18,.55);
      display: none;
      z-index: 1001;
    }
    .overlay.open { display: block; }

    .char-modal {
      width: min(430px, calc(100vw - 28px));
      margin: 70px auto;
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: rgba(18,24,50,.84);
      backdrop-filter: blur(12px);
      padding: 12px;
    }

    .char-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .char-item {
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      padding: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      cursor: pointer;
    }

    .char-item.active { border-color: rgba(255,255,255,.5); background: rgba(255,255,255,.16); }

    .char-dot { width: 22px; height: 22px; border-radius: 50%; }

    .status-line {
      font-family: Consolas, monospace;
      font-size: 12px;
      color: var(--txt-dim);
      margin-top: 6px;
      white-space: pre-wrap;
    }

    @media (max-width: 480px) {
      .panel { right: 8px; left: 8px; width: auto; bottom: 70px; height: calc(100vh - 84px); }
      .assistant-fab { right: 10px; bottom: 10px; }
    }
  </style>
</head>
<body>
  <button id="fab" class="assistant-fab" aria-label="Assistant √∂ffnen">√ó</button>

  <aside id="panel" class="panel open" role="dialog" aria-modal="false">
    <div class="panel-head">
      <div class="assistant-title">
        <button id="avatarBtn" class="avatar" title="Charakter w√§hlen">L</button>
        <div class="assistant-meta">
          <h2 id="charName">Luna</h2>
          <div id="llmStatus" class="status">Lade Status ...</div>
        </div>
      </div>
      <div class="head-actions">
        <button id="settingsToggle" class="icon-btn" title="Settings">‚öô</button>
        <button id="closeBtn" class="icon-btn" title="Schlie√üen">√ó</button>
      </div>
    </div>

    <div class="panel-tabs">
      <div class="tabs">
        <button id="tabChat" class="tab active">Chat</button>
        <button id="tabSettings" class="tab">Settings</button>
      </div>
      <button id="modeToggle" class="chip-btn mode-toggle">‚óã normal</button>
    </div>

    <div class="panel-body">
      <section id="chatView" class="chat-view active">
        <div id="chatScroll" class="chat-scroll"></div>
        <div class="panel-foot">
          <textarea id="chatInput" placeholder="Schreib hier..." rows="1"></textarea>
          <button id="sendBtn" class="send-btn" title="Senden">‚Üí</button>
        </div>
      </section>

      <section id="settingsView" class="settings-view">
        <div class="settings-scroll">
          <div class="settings-section" style="padding:8px 8px 10px;border-radius:12px;">
            <p class="section-title">Assistant Settings / Memory Admin</p>
            <div class="overview">
              <div class="ov-card"><strong id="ovHist">0</strong><span>History</span></div>
              <div class="ov-card"><strong id="ovUnc">0</strong><span>Uncensored</span></div>
              <div class="ov-card"><strong id="ovMem">0</strong><span>Memories</span></div>
              <div class="ov-card"><strong id="ovMode">normal</strong><span>Mode</span></div>
            </div>

            <div class="settings-actions">
              <button id="btnTrainPrepare" class="primary">Run Train Prepare</button>
              <button id="btnTrainAuto" class="primary">Auto Train</button>
              <button id="btnReset" class="danger">Complete Reset</button>
              <button id="btnRefresh" class="soft">Refresh Settings</button>
            </div>

            <div class="line">
              <label style="font-size:12px;color:var(--txt-dim)">minCurated</label>
              <input id="minCurated" type="number" value="20" />
            </div>
          </div>

          <details style="margin-top:10px;">
            <summary style="cursor:pointer;">Advanced</summary>
            <div class="line">
              <button id="btnLoraCfg" class="soft" style="flex:1;">LoRA Config</button>
              <button id="btnLoraStart" class="primary" style="flex:1;">LoRA Start</button>
            </div>
            <div class="line">
              <button id="btnExampleAdapter" class="soft" style="flex:1;">Example Adapter</button>
              <button id="btnTrainStatus" class="soft" style="flex:1;">Training Status</button>
            </div>
            <div class="line">
              <select id="datasetTier">
                <option value="curated">curated</option>
                <option value="memory">memory</option>
                <option value="merged">merged</option>
              </select>
              <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--txt-dim)">
                <input id="dryRun" type="checkbox" checked /> dryRun
              </label>
            </div>
            <div class="line">
              <input id="loraJobId" placeholder="jobId f√ºr Status" />
              <button id="btnLoraStatus" class="soft">Status</button>
            </div>
            <div class="status-line" id="adapterPathOut"></div>
            <div class="status-line" id="adapterHintOut"></div>
          </details>

          <div class="status-line" id="opsOut"></div>
        </div>
      </section>
    </div>
  </aside>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="char-modal">
      <h3 style="margin:0 0 10px;">Charakter ausw√§hlen</h3>
      <div id="charGrid" class="char-grid"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button id="closeOverlay" class="icon-btn">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script>
    const apiBase = '/assistant';
    const state = {
      open: true,
      settingsOpen: false,
      mode: 'normal',
      userId: 'luna',
      messages: [],
      loading: false,
      llmEnabled: null,
      lastAssistantText: '',
      lastUserText: '',
      selectedCharacter: 'luna',
      characters: [],
    };

    const el = {
      fab: document.getElementById('fab'),
      panel: document.getElementById('panel'),
      chatView: document.getElementById('chatView'),
      settingsView: document.getElementById('settingsView'),
      tabChat: document.getElementById('tabChat'),
      tabSettings: document.getElementById('tabSettings'),
      modeToggle: document.getElementById('modeToggle'),
      chatScroll: document.getElementById('chatScroll'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      llmStatus: document.getElementById('llmStatus'),
      charName: document.getElementById('charName'),
      avatarBtn: document.getElementById('avatarBtn'),
      settingsToggle: document.getElementById('settingsToggle'),
      closeBtn: document.getElementById('closeBtn'),
      overlay: document.getElementById('overlay'),
      charGrid: document.getElementById('charGrid'),
      closeOverlay: document.getElementById('closeOverlay'),
      btnTrainPrepare: document.getElementById('btnTrainPrepare'),
      btnTrainAuto: document.getElementById('btnTrainAuto'),
      btnReset: document.getElementById('btnReset'),
      btnRefresh: document.getElementById('btnRefresh'),
      minCurated: document.getElementById('minCurated'),
      btnLoraCfg: document.getElementById('btnLoraCfg'),
      btnLoraStart: document.getElementById('btnLoraStart'),
      btnExampleAdapter: document.getElementById('btnExampleAdapter'),
      btnTrainStatus: document.getElementById('btnTrainStatus'),
      btnLoraStatus: document.getElementById('btnLoraStatus'),
      loraJobId: document.getElementById('loraJobId'),
      datasetTier: document.getElementById('datasetTier'),
      dryRun: document.getElementById('dryRun'),
      opsOut: document.getElementById('opsOut'),
      adapterPathOut: document.getElementById('adapterPathOut'),
      adapterHintOut: document.getElementById('adapterHintOut'),
      ovHist: document.getElementById('ovHist'),
      ovUnc: document.getElementById('ovUnc'),
      ovMem: document.getElementById('ovMem'),
      ovMode: document.getElementById('ovMode'),
    };

    const palette = {
      luna: 'linear-gradient(135deg,#ff8bd6,#8ea6ff)',
      eva: 'linear-gradient(135deg,#f59e0b,#facc15)',
      news: 'linear-gradient(135deg,#3b82f6,#60a5fa)',
      support: 'linear-gradient(135deg,#10b981,#34d399)',
    };

    function isoDate(value) {
      const d = new Date(value || Date.now());
      return d.toISOString().slice(0, 10);
    }

    function fmtDateLabel(value) {
      try {
        return new Intl.DateTimeFormat('de-DE', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(value));
      } catch {
        return value;
      }
    }

    async function api(path, method = 'GET', body = null) {
      const response = await fetch(`${apiBase}${path}`, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined,
      });
      const json = await response.json().catch(() => ({}));
      if (!response.ok || json?.ok === false) {
        throw new Error(json?.error?.message || `HTTP ${response.status}`);
      }
      return json;
    }

    function setModeUi() {
      const dot = state.mode === 'uncensored' ? '‚óè' : '‚óã';
      el.modeToggle.textContent = `${dot} ${state.mode}`;
    }

    function applyCharacterUi() {
      const first = String(state.selectedCharacter || 'l').charAt(0).toUpperCase();
      el.avatarBtn.textContent = first;
      el.avatarBtn.style.background = palette[state.selectedCharacter] || palette.luna;
      el.charName.textContent = state.selectedCharacter;
    }

    function setStatus(text, cls = '') {
      el.llmStatus.textContent = text;
      el.llmStatus.className = `status ${cls}`.trim();
    }

    function togglePanel(force = null) {
      state.open = typeof force === 'boolean' ? force : !state.open;
      el.panel.classList.toggle('open', state.open);
      el.fab.textContent = state.open ? '√ó' : '‚ú¶';
    }

    function toggleSettings(force = null) {
      state.settingsOpen = typeof force === 'boolean' ? force : !state.settingsOpen;
      el.chatView.classList.toggle('active', !state.settingsOpen);
      el.settingsView.classList.toggle('active', state.settingsOpen);
      el.tabChat.classList.toggle('active', !state.settingsOpen);
      el.tabSettings.classList.toggle('active', state.settingsOpen);
    }

    function appendMessage(role, text, meta = '') {
      state.messages.push({
        id: `m-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
        role,
        text: String(text || ''),
        at: new Date().toISOString(),
        meta,
        feedback: null,
      });
      renderMessages();
    }

    function renderMessages() {
      const list = [];
      let previousDate = '';

      state.messages.forEach((m, idx) => {
        const day = isoDate(m.at);
        if (day !== previousDate) {
          list.push(`<div class="day-sep">${fmtDateLabel(m.at)}</div>`);
          previousDate = day;
        }

        const isUser = m.role === 'user';
        const avatar = isUser ? 'YOU' : (state.selectedCharacter || 'L').slice(0, 2).toUpperCase();
        const actions = isUser
          ? `<div class="msg-actions"><button class="action-btn" data-act="retry" data-id="${m.id}">‚Üª retry</button></div>`
          : `<div class="msg-actions">
              <button class="action-btn ${m.feedback === 'up' ? 'active' : ''}" data-act="up" data-id="${m.id}">üëç</button>
              <button class="action-btn ${m.feedback === 'down' ? 'active' : ''}" data-act="down" data-id="${m.id}">üëé</button>
              <button class="action-btn" data-act="retry" data-id="${m.id}">‚Üª</button>
              <button class="action-btn" data-act="edit" data-id="${m.id}">‚úé</button>
            </div>`;

        list.push(`
          <article class="message ${isUser ? 'user' : 'assistant'}" data-id="${m.id}" data-idx="${idx}">
            <div class="msg-avatar">${avatar}</div>
            <div class="msg-stack">
              <div class="bubble">${escapeHtml(m.text)}</div>
              <div class="meta">${escapeHtml(m.meta || '')}</div>
              ${actions}
            </div>
          </article>
        `);
      });

      if (state.loading) {
        list.push(`<div class="thinking">Luna denkt<span class="dots"></span></div>`);
      }

      el.chatScroll.innerHTML = list.join('');
      el.chatScroll.scrollTop = el.chatScroll.scrollHeight;
    }

    function escapeHtml(value) {
      return String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    async function refreshModeAndStatus() {
      try {
        const mode = await api(`/mode?characterId=${encodeURIComponent(state.selectedCharacter)}`);
        state.mode = mode.mode || 'normal';
        setModeUi();

        const settings = await api(`/settings?characterId=${encodeURIComponent(state.selectedCharacter)}`);
        state.llmEnabled = !!settings?.settings?.llmEnabled;
        setStatus(state.llmEnabled ? 'Live LLM' : 'Fallback', state.llmEnabled ? 'live' : 'fallback');

        const overview = settings?.settings?.memoryOverview || {};
        el.ovHist.textContent = Number(overview.historyCount || 0);
        el.ovUnc.textContent = Number(overview.uncensoredHistoryCount || 0);
        const memCount = Number(overview.goalsCount || 0) + Number(overview.notesCount || 0) + Number(overview.pinnedMemoriesCount || 0);
        el.ovMem.textContent = memCount;
        el.ovMode.textContent = settings?.settings?.mode || state.mode;
      } catch (error) {
        setStatus(`Statusfehler: ${error.message}`, 'fallback');
      }
    }

    async function sendMessage() {
      const message = el.chatInput.value.trim();
      if (!message || state.loading) return;
      el.chatInput.value = '';
      autosizeInput();
      appendMessage('user', message, 'gesendet');
      state.lastUserText = message;

      state.loading = true;
      renderMessages();

      try {
        const out = await api('/chat', 'POST', {
          characterId: state.selectedCharacter,
          mode: state.mode,
          message,
        });
        const reply = out.reply || '(leer)';
        state.lastAssistantText = reply;
        appendMessage('assistant', reply, 'neu ausgef√ºhrt');
      } catch (error) {
        appendMessage('assistant', `Fehler: ${error.message}`, 'fehler');
      } finally {
        state.loading = false;
        renderMessages();
      }
    }

    async function sendFeedback(value, assistantText, userText) {
      await api('/feedback', 'POST', {
        characterId: state.selectedCharacter,
        mode: state.mode,
        value,
        assistantMessage: assistantText,
        userMessage: userText,
      });
    }

    async function saveManualCorrection(userText, assistantText) {
      return api('/training/example', 'POST', {
        characterId: state.selectedCharacter,
        mode: state.mode,
        source: 'assistant-manual-edit',
        accepted: true,
        user: userText,
        assistant: assistantText,
        userOriginal: userText,
        assistantOriginal: assistantText,
      });
    }

    function autosizeInput() {
      el.chatInput.style.height = 'auto';
      el.chatInput.style.height = `${Math.min(el.chatInput.scrollHeight, 120)}px`;
    }

    function showOps(data) {
      el.opsOut.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    function renderAdapterPaths(training = null) {
      const paths = training?.lora?.adapterPaths || {};
      const active = String(paths.activeAdapterPath || '').trim() || '(kein aktiver Adapter)';
      const latest = String(paths.latestExpectedAdapterPath || '').trim() || '(kein letzter erwarteter Pfad)';
      const canAutoTrain = Boolean(training?.canAutoTrain);

      el.adapterPathOut.textContent = `Active Adapter Path: ${active}\nLatest Expected Path: ${latest}`;
      el.adapterHintOut.textContent = canAutoTrain
        ? 'Auto Train: bereit'
        : `Auto Train: noch nicht bereit (curated < minCurated)`;
      el.btnTrainAuto.disabled = !canAutoTrain;
    }

    async function refreshTrainingStatus(showLog = false) {
      const minCurated = Number(el.minCurated.value || 20);
      const status = await api(`/training/status?minCurated=${encodeURIComponent(minCurated)}`);
      renderAdapterPaths(status?.training || {});
      if (showLog) {
        showOps(status);
      }
      return status;
    }

    async function runSettingsAction(action) {
      try {
        if (action === 'prepare') {
          showOps(await api('/training/prepare', 'POST', {}));
          await refreshTrainingStatus();
          return;
        }
        if (action === 'auto') {
          showOps(await api('/training/auto', 'POST', { minCurated: Number(el.minCurated.value || 20) }));
          await refreshTrainingStatus();
          return;
        }
        if (action === 'reset') {
          if (!confirm('Wirklich kompletten State zur√ºcksetzen?')) return;
          showOps(await api('/reset', 'POST', { characterId: state.selectedCharacter }));
          await refreshModeAndStatus();
          return;
        }
        if (action === 'loraCfg') {
          showOps(await api('/training/lora/config', 'GET'));
          return;
        }
        if (action === 'loraStart') {
          showOps(await api('/training/lora/start', 'POST', {
            datasetTier: el.datasetTier.value,
            minCurated: Number(el.minCurated.value || 20),
            dryRun: !!el.dryRun.checked,
          }));
          await refreshTrainingStatus();
          return;
        }
        if (action === 'exampleAdapter') {
          showOps(await api('/training/lora/example-adapter', 'POST', {
            promote: true,
            adapterPrefix: state.selectedCharacter || 'luna-adapter',
          }));
          await refreshTrainingStatus();
          return;
        }
        if (action === 'loraStatus') {
          const jobId = el.loraJobId.value.trim();
          const q = jobId ? `?jobId=${encodeURIComponent(jobId)}` : '';
          showOps(await api(`/training/lora/status${q}`, 'GET'));
          return;
        }
        if (action === 'refresh') {
          await refreshModeAndStatus();
          await refreshTrainingStatus(true);
          showOps('Settings + Training Status aktualisiert');
          return;
        }
        if (action === 'status') {
          await refreshTrainingStatus(true);
          return;
        }
      } catch (error) {
        showOps(`Fehler: ${error.message}`);
      }
    }

    function openCharacterOverlay() {
      el.overlay.classList.add('open');
    }

    function closeCharacterOverlay() {
      el.overlay.classList.remove('open');
    }

    function renderCharacters() {
      const chars = state.characters.length
        ? state.characters
        : [{ id: 'luna', name: 'Luna', note: 'Default' }, { id: 'eva', name: 'Eva', note: 'Trading' }];

      el.charGrid.innerHTML = chars.map((c) => {
        const id = String(c.id || '').toLowerCase();
        const active = id === state.selectedCharacter ? 'active' : '';
        const dotStyle = `background:${palette[id] || palette.luna}`;
        return `
          <button class="char-item ${active}" data-char="${id}">
            <span class="char-dot" style="${dotStyle}"></span>
            <span style="text-align:left;display:flex;flex-direction:column;gap:2px;">
              <strong style="font-size:13px;color:var(--txt)">${escapeHtml(c.name || id)}</strong>
              <small style="font-size:11px;color:var(--txt-dim)">${escapeHtml(c.note || '')}</small>
            </span>
          </button>
        `;
      }).join('');
    }

    async function loadCharacters() {
      try {
        const out = await api('/characters', 'GET');
        state.characters = Array.isArray(out?.characters) ? out.characters : [];
        renderCharacters();
      } catch {
        renderCharacters();
      }
    }

    async function handleMessageAction(target) {
      const btn = target.closest('[data-act]');
      if (!btn) return;
      const act = btn.getAttribute('data-act');
      const wrap = btn.closest('.message');
      if (!wrap) return;
      const idx = Number(wrap.getAttribute('data-idx'));
      const msg = state.messages[idx];
      if (!msg) return;

      try {
        if (act === 'up' || act === 'down') {
          const assistantText = msg.text;
          const userText = [...state.messages].slice(0, idx).reverse().find((x) => x.role === 'user')?.text || state.lastUserText;
          await sendFeedback(act, assistantText, userText);
          msg.feedback = act;
          msg.meta = act === 'up' ? 'üëç feedback gespeichert' : 'üëé feedback gespeichert';
          renderMessages();
          return;
        }

        if (act === 'retry') {
          const candidate = msg.role === 'user'
            ? msg.text
            : [...state.messages].slice(0, idx).reverse().find((x) => x.role === 'user')?.text;
          if (!candidate) return;
          el.chatInput.value = candidate;
          autosizeInput();
          await sendMessage();
          return;
        }

        if (act === 'edit' && msg.role === 'assistant') {
          const edited = prompt('Assistant Antwort bearbeiten', msg.text);
          if (!edited || !edited.trim()) return;
          const userText = [...state.messages].slice(0, idx).reverse().find((x) => x.role === 'user')?.text || '';
          await saveManualCorrection(userText, edited.trim());
          msg.text = edited.trim();
          msg.meta = '‚úèÔ∏è bearbeitet + als Training gespeichert';
          renderMessages();
        }
      } catch (error) {
        showOps(`Action Fehler: ${error.message}`);
      }
    }

    async function toggleMode() {
      const target = state.mode === 'normal' ? 'uncensored' : 'normal';
      let password = '';
      if (target === 'uncensored') {
        password = prompt('Passwort f√ºr uncensored mode (falls gesetzt):', '') || '';
      }
      try {
        const out = await api('/mode', 'POST', {
          characterId: state.selectedCharacter,
          mode: target,
          password,
        });
        state.mode = out.mode || target;
        setModeUi();
      } catch (error) {
        showOps(`Mode Fehler: ${error.message}`);
      }
    }

    function wireEvents() {
      el.fab.addEventListener('click', () => togglePanel());
      el.closeBtn.addEventListener('click', () => togglePanel(false));
      el.settingsToggle.addEventListener('click', () => toggleSettings(true));
      el.tabChat.addEventListener('click', () => toggleSettings(false));
      el.tabSettings.addEventListener('click', () => toggleSettings(true));
      el.modeToggle.addEventListener('click', toggleMode);
      el.sendBtn.addEventListener('click', sendMessage);

      el.chatInput.addEventListener('input', autosizeInput);
      el.chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      el.chatScroll.addEventListener('click', (e) => {
        handleMessageAction(e.target);
      });

      el.btnTrainPrepare.addEventListener('click', () => runSettingsAction('prepare'));
      el.btnTrainAuto.addEventListener('click', () => runSettingsAction('auto'));
      el.btnReset.addEventListener('click', () => runSettingsAction('reset'));
      el.btnRefresh.addEventListener('click', () => runSettingsAction('refresh'));
      el.btnLoraCfg.addEventListener('click', () => runSettingsAction('loraCfg'));
      el.btnLoraStart.addEventListener('click', () => runSettingsAction('loraStart'));
      el.btnExampleAdapter.addEventListener('click', () => runSettingsAction('exampleAdapter'));
      el.btnTrainStatus.addEventListener('click', () => runSettingsAction('status'));
      el.btnLoraStatus.addEventListener('click', () => runSettingsAction('loraStatus'));

      el.avatarBtn.addEventListener('click', openCharacterOverlay);
      el.closeOverlay.addEventListener('click', closeCharacterOverlay);
      el.overlay.addEventListener('click', (e) => {
        if (e.target === el.overlay) closeCharacterOverlay();
      });

      el.charGrid.addEventListener('click', async (e) => {
        const item = e.target.closest('[data-char]');
        if (!item) return;
        state.selectedCharacter = item.getAttribute('data-char');
        applyCharacterUi();
        renderCharacters();
        closeCharacterOverlay();
        await refreshModeAndStatus();
      });
    }

    async function init() {
      wireEvents();
      setModeUi();
      applyCharacterUi();
      await loadCharacters();
      await refreshModeAndStatus();
      await refreshTrainingStatus();
      appendMessage('assistant', 'Hi ‚ú® Ich bin bereit. Schreib mir eine Nachricht oder √∂ffne Settings f√ºr Training/LoRA.', 'bereit');
      autosizeInput();
    }

    init();
  </script>
</body>
</html>
